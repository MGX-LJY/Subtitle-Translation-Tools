# Subtitle Translation Tools 系统架构概述

## 项目概况

Subtitle Translation Tools 是一个基于 AI 的智能字幕翻译应用程序，专为日语到中文的成人影片字幕翻译而设计。该系统采用现代 Python GUI 框架结合 OpenAI API，提供高效、专业的字幕翻译服务。

**核心特性：**
- 基于 PySide6 的现代图形用户界面
- 集成 OpenAI GPT 模型进行智能翻译
- 支持 8 通道并发处理，显著提升翻译效率
- 专业的字幕润色和后处理功能
- 持久化配置管理系统
- 完整的 SRT 文件格式支持

**应用场景：**
- 专业字幕翻译工作流
- 批量字幕文件处理
- 高质量翻译输出要求
- 需要人工审核和修正的翻译项目

## 技术栈分析

### 核心技术栈

**前端框架：**
- `PySide6` - Qt6 的 Python 绑定，提供现代化的桌面 GUI 框架
- `QtCore`, `QtWidgets`, `QtGui` - 完整的 UI 组件生态系统

**AI 集成：**
- `OpenAI Python SDK` - 官方 OpenAI API 客户端
- `AsyncOpenAI` - 异步 API 调用支持，提升并发性能

**异步处理：**
- `asyncio` - Python 原生异步编程框架
- `QThread` - Qt 线程系统，UI 与业务逻辑分离

**数据处理：**
- `dataclasses` - 现代 Python 数据结构定义
- `pathlib` - 现代文件路径处理
- `typing` - 静态类型注解支持

**配置管理：**
- `JSON` - 轻量级配置文件格式
- 动态配置加载与持久化

**日志系统：**
- `logging` - Python 标准日志框架
- 多输出目标（控制台 + 文件）

## 架构模式

该系统采用 **桌面应用 MVC (Model-View-Controller) 架构模式** 的变体，结合了现代异步处理和事件驱动设计：

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   View Layer    │    │ Controller Layer│    │   Model Layer   │
│   (PySide6 UI)  │◄──►│   (MainWindow)  │◄──►│  (Data Classes) │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                        │                        │
         │                        ▼                        │
         │              ┌─────────────────┐                │
         │              │ Service Layer   │                │
         └──────────────│(TranslateWorker)│────────────────┘
                        └─────────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │ External APIs   │
                        │  (OpenAI API)   │
                        └─────────────────┘
```

### 1. 服务层 (Services Layer)

**TranslateWorker (QThread)**
- **职责**: 异步翻译处理、API 调用管理、并发控制
- **特性**: 
  - 8 通道并发限制 (`MAX_CONCURRENCY=8`)
  - 异步事件循环管理 (`asyncio`)
  - 统一的 API 响应解析 (`_extract()`)
  - 实时进度和结果反馈 (Qt Signals)

**配置服务**
- **load_config()**: 配置文件加载与验证
- **save_config()**: 配置持久化存储
- **Config dataclass**: 类型安全的配置数据结构

**文件处理服务**
- **parse_srt()**: SRT 文件解析器
- **write_srt()**: SRT 文件生成器
- **_blk_to_cue()**: 字幕块转换器

### 2. MCP接口层 (MCP Interface Layer)  

虽然当前系统未直接使用 MCP 协议，但设计上具备良好的接口抽象：

**数据接口**
- `SubtitleCue` - 字幕数据的标准化表示
- `Config` - 配置数据的统一接口

**服务接口**
- OpenAI API 的异步调用接口
- 文件 I/O 的统一抽象接口
- Qt 信号槽的事件通信接口

### 3. 协作流程层 (Collaboration Layer)

**用户交互流程**
```
用户操作 → UI 事件 → 控制器处理 → 服务调用 → 模型更新 → UI 刷新
```

**翻译工作流程**
```
SRT 加载 → 解析字幕 → 并发翻译 → 结果润色 → 导出保存
```

**异步协作模式**
- UI 线程保持响应性
- 工作线程处理耗时操作
- 信号槽实现线程间通信

## 核心组件

### 数据模型组件

**Config (配置管理)**
```python
@dataclass
class Config:
    api_key: str = ""           # OpenAI API 密钥
    base_url: str = ""          # API 基础 URL
    model: str = "gpt-4o-mini"  # 使用的 GPT 模型
    target_lang: str = "中文"   # 目标翻译语言
```

**SubtitleCue (字幕条目)**
```python
@dataclass
class SubtitleCue:
    index: int                  # 字幕序号
    start: str                  # 开始时间
    end: str                    # 结束时间
    original: str               # 原始文本
    translation: str = ""       # 翻译文本
    fixed_text: str = ""        # 修复后文本
```

### 视图组件

**MainWindow (主窗口)**
- 工具栏：文件操作、翻译控制、设置管理
- 表格视图：字幕数据的表格化展示和编辑
- 进度条：实时显示翻译进度
- 状态栏：显示应用状态和 Token 使用量

**SettingsDialog (设置对话框)**
- API 配置输入界面
- 模型选择下拉菜单
- 语言设置选项
- 配置验证和保存

### 控制器组件

**主窗口控制器方法**
- `open_file()`: 文件加载控制
- `translate_all()` / `fix_all()`: 翻译任务启动
- `save_file()` / `export_file()`: 文件保存控制
- `_refresh()`: UI 数据刷新管理

### 服务组件

**TranslateWorker (翻译服务)**
- 异步翻译任务调度
- 并发限制和负载均衡
- 错误处理和重试机制
- 实时结果反馈

## 数据流设计

### 主要数据流路径

**1. 配置数据流**
```
启动 → load_config() → Config 对象 → MainWindow.cfg
用户设置 → SettingsDialog → save_config() → JSON 文件
```

**2. 字幕数据流**
```
SRT 文件 → parse_srt() → List[SubtitleCue] → 表格显示
原文本 → OpenAI API → 翻译文本 → SubtitleCue.translation
翻译文本 → OpenAI API → 修复文本 → SubtitleCue.fixed_text
SubtitleCue 列表 → write_srt() → 输出 SRT 文件
```

**3. 异步处理数据流**
```
UI 请求 → TranslateWorker 创建 → 异步任务队列
并发 API 调用 → 结果收集 → Qt 信号发送
信号接收 → UI 更新 → 用户反馈
```

**4. 错误处理数据流**
```
异常捕获 → 错误分类 → 日志记录 → 用户通知
网络错误 → 重试机制 → 降级处理 → 状态恢复
```

### 数据持久化策略

**配置持久化**
- JSON 格式存储
- 应用启动时自动加载
- 设置变更时即时保存
- UTF-8 编码确保中文支持

**翻译历史管理**
- 内存中维护操作历史
- 支持撤销操作
- 会话级别的历史记录

## 系统边界和约束

### 功能边界

**支持的功能**
- SRT 格式字幕文件处理
- OpenAI GPT 系列模型翻译
- 简体中文目标语言翻译
- 桌面环境下的图形化操作

**不支持的功能**
- 其他字幕格式（VTT、ASS、SSA）
- 其他 AI 翻译服务提供商
- 命令行界面操作模式
- 云端部署和远程访问

### 技术约束

**性能约束**
- 并发请求限制：8 个同时进行的 API 调用
- API 超时设置：25 秒请求超时
- 内存使用：受字幕文件大小和历史记录深度影响

**平台约束**
- Python 3.8+ 运行环境
- PySide6 GUI 框架依赖
- 桌面操作系统支持（Windows、macOS、Linux）
- 网络连接要求：稳定的互联网访问

**安全约束**
- API 密钥本地存储（未加密）
- 配置文件权限控制
- 网络请求 HTTPS 加密传输

### 业务约束

**使用场景限制**
- 专门针对成人影片字幕翻译
- 日语到中文的翻译方向
- 需要人工审核的专业翻译场景

**数据处理约束**
- 字幕文件格式限制为 SRT
- 文本内容长度受 API 限制
- 翻译质量依赖于 AI 模型性能

## 部署架构

### 单机部署架构

```
┌─────────────────────────────────────────────────────────┐
│                    用户桌面环境                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │              应用程序进程                        │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │    │
│  │  │    GUI      │  │   业务逻辑   │  │   数据存储   │ │    │
│  │  │  (PySide6)  │  │(TranslateW.)│  │   (JSON)    │ │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                             │
                             │ HTTPS API 调用
                             ▼
┌─────────────────────────────────────────────────────────┐
│                    外部服务                              │
│  ┌─────────────────────────────────────────────────┐    │
│  │                OpenAI API                       │    │
│  │         (gpt-4o-mini / gpt-4o)                  │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

### 部署组件说明

**应用程序组件**
- **GUI 层**: PySide6 桌面应用界面
- **业务逻辑层**: 翻译处理和文件管理
- **数据存储层**: 本地配置和临时数据

**外部依赖组件**
- **OpenAI API 服务**: 远程 AI 翻译服务
- **网络基础设施**: 稳定的互联网连接
- **操作系统服务**: 文件系统、GUI 子系统

### 部署要求

**硬件要求**
- CPU: 现代多核处理器（支持并发处理）
- 内存: 最低 4GB RAM（推荐 8GB+）
- 存储: 100MB+ 可用磁盘空间
- 网络: 稳定的宽带互联网连接

**软件要求**
- Python 3.8+ 运行时环境
- PySide6 GUI 框架
- OpenAI Python SDK
- 支持的操作系统：Windows 10+、macOS 10.14+、Ubuntu 18.04+

**网络要求**
- 出站 HTTPS 连接（端口 443）
- 访问 OpenAI API 端点
- 带宽要求：最低 1Mbps（推荐 5Mbps+）

### 配置和维护

**安装配置**
1. Python 环境准备和依赖安装
2. OpenAI API 密钥获取和配置
3. 应用程序启动和设置验证

**日常维护**
- 配置文件备份 (`main.config.json`)
- 日志文件轮转 (`translator.log`)
- API 密钥安全管理
- 软件依赖版本更新